<!DOCTYPE html>
<html lang="th">
  <%- include('partials/head') %>
  <body
    class="min-h-screen flex flex-col bg-gradient-to-b from-black via-neutral-900 to-zinc-950 text-white font-[Prompt]"
  >
    <%- include('partials/navbar') %>

    <main class="flex-1 mx-auto max-w-5xl px-4 py-14">
      <div class="grid md:grid-cols-2 gap-10">
        <!-- EVENT INFO -->
        <div
          class="bg-neutral-900/80 border border-red-600/40 rounded-2xl shadow-[0_0_25px_rgba(229,9,20,0.25)] overflow-hidden backdrop-blur-md"
        >
          <% if (event.image_url) { %>
          <div
            class="h-64 bg-cover bg-center"
            style="background-image: url('<%= event.image_url %>')"
          ></div>
          <% } else { %>
          <div
            class="h-64 bg-cover bg-center bg-[url('/img/concert-bg.jpg')] opacity-70"
          ></div>
          <% } %>

          <div class="p-6">
            <span
              class="bg-red-600/80 text-white text-xs px-3 py-1 rounded-full shadow-[0_0_8px_rgba(229,9,20,0.5)]"
            >
              <%= event.category %>
            </span>

            <h1 class="mt-3 text-3xl font-semibold text-white">
              <%= event.title %>
            </h1>

            <p class="mt-4 text-gray-300 leading-relaxed">
              <%= event.description %>
            </p>

            <div class="mt-6 space-y-2 text-sm text-gray-400">
              <div>
                <i class="fa-solid fa-location-dot text-red-500"></i>
                <span class="ml-1"><%= event.location %></span>
              </div>
              <div>
                <i class="fa-solid fa-coins text-red-500"></i>
                <span class="ml-1">ราคา ฿<%= event.price %></span>
              </div>
              <div>
                <i class="fa-solid fa-ticket text-red-500"></i>
                <span class="ml-1"
                  >ตั๋วคงเหลือ <%= event.available_tickets %></span
                >
              </div>
              <div>
                <i class="fa-solid fa-user text-red-500"></i>
                <span class="ml-1"
                  >ผู้จัด: <%= event.organizer_id ? event.organizer_id.email :
                  "-" %></span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- PURCHASE PANEL -->
        <div
          class="bg-neutral-900/80 border border-red-600/40 rounded-2xl shadow-[0_0_25px_rgba(229,9,20,0.25)] p-8 backdrop-blur-md"
        >
          <h2
            class="font-bangers text-4xl text-red-500 drop-shadow-[0_0_12px_rgba(229,9,20,0.8)]"
          >
            ซื้อบัตร
          </h2>

          <% if (user) { %> <% if (event.available_tickets > 0) { %>
          <form
            id="addCartForm"
            method="post"
            action="/add-to-cart/<%= event._id %>"
            class="mt-8 grid gap-5"
          >
            <label class="grid gap-1">
              <span class="text-sm text-gray-300">จำนวน</span>
              <input
                type="number"
                name="quantity"
                value="1"
                min="1"
                max="<%= event.available_tickets %>"
                class="w-full rounded-lg bg-neutral-800 border border-red-500/40 focus:border-red-500 focus:ring-2 focus:ring-red-600 outline-none px-3 py-2 text-white"
              />
            </label>

            <button
              type="submit"
              class="w-full py-2.5 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold shadow-[0_0_15px_rgba(229,9,20,0.6)] transition hover:scale-[1.02]"
            >
              <i class="fa-solid fa-cart-plus mr-1"></i> เพิ่มเข้าตะกร้า
            </button>
          </form>
          <% } else { %>
          <p class="mt-6 text-red-400 font-semibold">Sold Out</p>
          <% } %> <% } else { %>
          <a
            href="/signin"
            class="block w-full mt-8 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 text-white text-center font-semibold shadow-[0_0_15px_rgba(229,9,20,0.6)] transition hover:scale-[1.02]"
          >
            เข้าสู่ระบบ / สมัครสมาชิก
          </a>
          <% } %>

          <a
            href="/"
            class="mt-5 inline-block text-center w-full py-2.5 rounded-lg border border-red-500/40 hover:bg-red-600/20 text-white font-semibold transition"
          >
            <i class="fa-solid fa-arrow-left mr-1"></i> กลับหน้าหลัก
          </a>
        </div>
      </div>
    </main>

    <%- include('partials/footer') %>
  </body>
</html>

<script>
  document
    .getElementById("addCartForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const fd = new FormData(form);
      const quantity = fd.get("quantity") || 1;

      try {
        const res = await fetch(form.action, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quantity }),
        });

        const data = await res.json();

        if (res.ok) {
          Swal.fire({
            icon: "success",
            title: "เพิ่มเข้าตะกร้าสำเร็จ!",
            text: data.msg || "คุณสามารถดูรายการในหน้าตะกร้าได้เลย",
            confirmButtonColor: "#e50914",
            background: "#1a1a1a",
            color: "#fff",
            iconColor: "#e50914",
          });
        } else {
          Swal.fire({
            icon: "warning",
            title: "ไม่สามารถเพิ่มได้",
            text: data.msg || "มีบางอย่างผิดพลาด",
            confirmButtonColor: "#e50914",
            background: "#1a1a1a",
            color: "#fff",
            iconColor: "#e50914",
          });
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "เกิดข้อผิดพลาด",
          text: "ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้",
          confirmButtonColor: "#e50914",
          background: "#1a1a1a",
          color: "#fff",
          iconColor: "#e50914",
        });
      }
    });
</script>