<!DOCTYPE html>
<html lang="th">
  <%- include('partials/head') %>
  <body class="min-h-screen bg-gradient-to-b from-black via-neutral-900 to-zinc-950 text-white font-[Prompt]">
    <%- include('partials/navbar') %>

    <main class="mx-auto max-w-6xl px-4 py-14">
      <div class="flex items-center justify-between mb-10">
        <h1 class="font-bangers text-5xl text-red-500 drop-shadow-[0_0_12px_rgba(229,9,20,0.8)]">
          Organizer Dashboard
        </h1>
        <a
          href="/organizer/create-event"
          class="px-5 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold flex items-center gap-2 shadow-[0_0_15px_rgba(229,9,20,0.5)] transition hover:scale-[1.02]"
        >
          <i class="fa-solid fa-plus"></i> สร้างกิจกรรมใหม่
        </a>
      </div>

      <% if (events && events.length > 0) { %>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          <% events.forEach(ev => { %>
            <div
              class="bg-neutral-900/80 border border-red-600/40 rounded-2xl shadow-[0_0_25px_rgba(229,9,20,0.25)] overflow-hidden backdrop-blur-md p-5 transition-transform hover:scale-[1.02]"
            >
              <% if (ev.image_url) { %>
                <div
                  class="h-40 bg-cover bg-center rounded-xl mb-4"
                  style="background-image:url('<%= ev.image_url %>')"
                ></div>
              <% } %>

              <h3 class="text-xl font-semibold text-white"><%= ev.title %></h3>
              <p class="mt-2 text-gray-300 line-clamp-2"><%= ev.description %></p>

              <div class="mt-3 flex justify-between text-sm text-gray-400">
                <span><i class="fa-solid fa-ticket text-red-500"></i> <%= ev.available_tickets %> ใบ</span>
                <span><i class="fa-solid fa-coins text-red-500"></i> ฿<%= ev.price %></span>
              </div>

              <div class="mt-5 flex items-center justify-between gap-2">
                <button
                  class="w-1/2 py-2 rounded-lg border border-red-500/40 hover:bg-red-600/20 text-white transition edit-btn"
                  data-id="<%= ev._id %>"
                >
                  <i class="fa-solid fa-pen-to-square mr-1"></i> แก้ไข
                </button>
                <button
                  class="w-1/2 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold shadow-[0_0_12px_rgba(229,9,20,0.5)] transition delete-btn"
                  data-id="<%= ev._id %>"
                >
                  <i class="fa-solid fa-trash mr-1"></i> ลบ
                </button>
              </div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p class="text-center text-gray-400 mt-10">ยังไม่มีกิจกรรมที่สร้างไว้</p>
      <% } %>
    </main>

    <script>
      // แก้ไขกิจกรรม (redirect)
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          window.location.href = `/organizer/create-event?edit=${id}`;
        });
      });

      // ลบกิจกรรม (ใช้ Swal)
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');

          const confirmResult = await Swal.fire({
            title: 'คุณแน่ใจหรือไม่?',
            text: 'การลบนี้ไม่สามารถย้อนกลับได้!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ลบเลย',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#e50914',
            cancelButtonColor: '#666',
            background: '#1a1a1a',
            color: '#fff',
            iconColor: '#e50914'
          });

          if (!confirmResult.isConfirmed) return;

          try {
            const res = await fetch(`/organizer/event/${id}`, { method: 'DELETE' });
            const data = await res.json();

            if (res.ok) {
              await Swal.fire({
                icon: 'success',
                title: 'ลบกิจกรรมสำเร็จ',
                text: data.msg || 'ข้อมูลถูกลบออกเรียบร้อยแล้ว',
                confirmButtonColor: '#e50914',
                background: '#1a1a1a',
                color: '#fff',
                iconColor: '#e50914'
              });
              location.reload();
            } else {
              Swal.fire({
                icon: 'error',
                title: 'ลบไม่สำเร็จ',
                text: data.msg || 'เกิดข้อผิดพลาดในการลบกิจกรรม',
                confirmButtonColor: '#e50914',
                background: '#1a1a1a',
                color: '#fff',
                iconColor: '#e50914'
              });
            }
          } catch (err) {
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด',
              text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
              confirmButtonColor: '#e50914',
              background: '#1a1a1a',
              color: '#fff',
              iconColor: '#e50914'
            });
          }
        });
      });
    </script>

    <%- include('partials/footer') %>
  </body>
</html>
