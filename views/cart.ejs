<!DOCTYPE html>
<html lang="th">
  <%- include('partials/head') %>
  <body class="min-h-screen flex flex-col bg-gradient-to-b from-black via-neutral-900 to-zinc-950 text-white font-[Prompt]">
    <%- include('partials/navbar') %>

    <main class="flex-1 mx-auto max-w-5xl px-4 py-14">
      <h1 class="font-bangers text-5xl text-red-500 drop-shadow-[0_0_12px_rgba(229,9,20,0.8)] mb-8">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>

      <% if (cartItems && cartItems.length) { %>
        <div id="cartList" class="grid gap-4">
          <% cartItems.forEach(item => { %>
            <div class="bg-neutral-900/80 border border-red-600/40 shadow-[0_0_25px_rgba(229,9,20,0.2)] rounded-2xl p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4 transition-transform hover:scale-[1.01]">
              <div class="flex items-center gap-4">
                <% if (item.event_id && item.event_id.image_url) { %>
                  <img src="<%= item.event_id.image_url %>" class="h-20 w-32 object-cover rounded-lg border border-red-500/30" alt="cover">
                <% } else { %>
                  <div class="h-20 w-32 rounded-lg bg-neutral-700 flex items-center justify-center text-gray-400 border border-red-500/20">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>
                <% } %>
                <div>
                  <h3 class="text-lg font-semibold text-white"><%= item.event_id ? item.event_id.title : "Event" %></h3>
                  <div class="text-sm text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <%= item.quantity %></div>
                </div>
              </div>

              <div class="flex items-center gap-4">
                <div class="text-red-400 font-bold text-lg">‡∏ø<%= item.price %></div>
                <button data-id="<%= item._id %>" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white text-sm font-semibold shadow-[0_0_10px_rgba(229,9,20,0.4)] transition remove-btn">
                  <i class="fa-solid fa-trash-can"></i> ‡∏•‡∏ö
                </button>
              </div>
            </div>
          <% }) %>
        </div>

        <div id="summary" class="bg-neutral-900/80 border border-red-600/40 rounded-2xl shadow-[0_0_25px_rgba(229,9,20,0.2)] p-6 mt-8 backdrop-blur-md">
          <div class="flex items-center justify-between text-sm text-gray-300">
            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            <span id="totalItems" class="font-medium"><%= totalItems %></span>
          </div>
          <div class="flex items-center justify-between mt-2 text-sm text-gray-300">
            <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</span>
            <span id="totalPrice" class="text-red-400 font-bold text-lg">‡∏ø<%= totalPrice %></span>
          </div>
          <button id="checkoutBtn" class="w-full mt-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold shadow-[0_0_15px_rgba(229,9,20,0.6)] transition hover:scale-[1.02]">
            <i class="fa-solid fa-bolt"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </button>
        </div>
      <% } else { %>
        <p class="text-gray-400 text-center mt-10">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
      <% } %>
    </main>

    <!-- ‚úÖ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');

          const confirmResult = await Swal.fire({
            title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
            text: '‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#e50914',
            cancelButtonColor: '#555',
            background: '#1a1a1a',
            color: '#fff',
            iconColor: '#e50914'
          });

          if (!confirmResult.isConfirmed) return;

          try {
            const r = await fetch('/cart/remove/' + id, { method: 'DELETE' });
            const data = await r.json();

            if (r.ok) {
              Swal.fire({
                icon: 'success',
                title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
                confirmButtonColor: '#e50914',
                background: '#1a1a1a',
                color: '#fff',
                iconColor: '#e50914'
              }).then(() => {
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                location.reload();
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: data.msg || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                confirmButtonColor: '#e50914',
                background: '#1a1a1a',
                color: '#fff',
                iconColor: '#e50914'
              });
            }
          } catch (err) {
            Swal.fire({
              icon: 'error',
              title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ',
              confirmButtonColor: '#e50914',
              background: '#1a1a1a',
              color: '#fff',
              iconColor: '#e50914'
            });
          }
        });
      });

      // ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', async () => {
          const confirmPay = await Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô?',
            text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡πã‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏•‡∏¢',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#e50914',
            cancelButtonColor: '#555',
            background: '#1a1a1a',
            color: '#fff',
            iconColor: '#e50914'
          });

          if (!confirmPay.isConfirmed) return;

          try {
            const r = await fetch('/cart/checkout', { method: 'POST' });
            const data = await r.json();

            if (r.ok) {
              Swal.fire({
                icon: 'success',
                title: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: data.msg || '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ üé´',
                confirmButtonText: '‡∏î‡∏π‡∏ï‡∏±‡πã‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
                confirmButtonColor: '#e50914',
                background: '#1a1a1a',
                color: '#fff',
                iconColor: '#e50914'
              }).then(() => location.href = '/my-tickets');
            } else {
              Swal.fire({
                icon: 'warning',
                title: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: data.msg || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                confirmButtonColor: '#e50914',
                background: '#1a1a1a',
                color: '#fff',
                iconColor: '#e50914'
              });
            }
          } catch (err) {
            Swal.fire({
              icon: 'error',
              title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ',
              confirmButtonColor: '#e50914',
              background: '#1a1a1a',
              color: '#fff',
              iconColor: '#e50914'
            });
          }
        });
      }
    </script>

    <%- include('partials/footer') %>
  </body>
</html>